ВКЛЮЧИТЬ стандартная_библиотека.*

!ВКЛЮЧИТЬ стандартная_библиотека.время
!ВКЛЮЧИТЬ стандартная_библиотека.строки
!ВКЛЮЧИТЬ стандартная_библиотека.рандом
!ВКЛЮЧИТЬ стандартная_библиотека.конкурентность
!ВКЛЮЧИТЬ стандартная_библиотека.структуры.сложные_структуры
ВКЛЮЧИТЬ стандартная_библиотека._.true


ОПРЕДЕЛИТЬ ПРОЦЕДУРУ тест(ранд)(
    ЦИКЛ счет ОТ 1 ДО 5 (
        НАПЕЧАТАТЬ "ПРИВЕТ! " + в_строку(счет);
    )

    ВЕРНУТЬ ранд:получить_целое_в_диапазоне(1, 100);
)


ОПРЕДЕЛИТЬ ПРОЦЕДУРУ тест_фон()(
    НАПЕЧАТАТЬ "тест_фон";
    ВЕРНУТЬ 115;
)


ОПРЕДЕЛИТЬ ПРОЦЕДУРУ тест2(событие)(
   ЗАДАТЬ ж =  ЖДАТЬ В ФОНЕ тест_фон();
   НАПЕЧАТАТЬ  ЖДАТЬ В ФОНЕ тест_фон();

     ЕСЛИ ИСТИНА ТО (
        НАПЕЧАТАТЬ ЖДАТЬ В ФОНЕ тест_фон();
        НАПЕЧАТАТЬ "НАПЕЧАТАТЬ ЖДАТЬ В ФОНЕ тест_фон()";
     )

     ЕСЛИ ЛОЖЬ ТО (
     )
     ИНАЧЕ ЕСЛИ ЖДАТЬ В ФОНЕ тест_фон() ТО (
        НАПЕЧАТАТЬ ЖДАТЬ В ФОНЕ тест_фон();
        НАПЕЧАТАТЬ "НАПЕЧАТАТЬ ЖДАТЬ В ФОНЕ тест_фон()";
     )

    ПОКА НЕ событие:выполнено() (
        ЖДАТЬ В ФОНЕ тест_фон();
        НАПЕЧАТАТЬ "ПРИВЕТ! тест2";
    )

    ЦИКЛ ОТ (ЖДАТЬ В ФОНЕ тест_фон()) - 1 ДО ЖДАТЬ В ФОНЕ тест_фон() (
        ЖДАТЬ В ФОНЕ тест_фон();
    )


    ВЕРНУТЬ 2;
)


ОПРЕДЕЛИТЬ ПРОЦЕДУРУ дать_число()(
    ЖДАТЬ В ФОНЕ спать_в_числе();
    ЦИКЛ ОТ 1 ДО 100 (
        2 + 2 * 2;
    )

   ! ЖДАТЬ В ФОНЕ дать_число();
    НАПЕЧАТАТЬ "ДОЖДАЛСЯ!";
    ВЕРНУТЬ 3;
)

ОПРЕДЕЛИТЬ ПРОЦЕДУРУ спать_в_числе()(
    ЖДАТЬ В ФОНЕ спать_в_числе2();
    ЦИКЛ ОТ 1 ДО 3 (
        ПРОПУСТИТЬ;
    )

    ВЕРНУТЬ 3;
)
ОПРЕДЕЛИТЬ ПРОЦЕДУРУ спать_в_числе2()(
    ЖДАТЬ В ФОНЕ спать_в_числе3();
    ЖДАТЬ В ФОНЕ спать_в_числе3();
    ЖДАТЬ В ФОНЕ спать_в_числе3();
    ЖДАТЬ В ФОНЕ спать_в_числе3();
    ЦИКЛ ОТ 1 ДО 3 (
        ПРОПУСТИТЬ;
    )

    ВЕРНУТЬ 3;
)
ОПРЕДЕЛИТЬ ПРОЦЕДУРУ спать_в_числе3()(
    ЦИКЛ ОТ 1 ДО 3 (
        ПРОПУСТИТЬ;
    )

    ВЕРНУТЬ 3;
)


ОПРЕДЕЛИТЬ ПРОЦЕДУРУ спам_в_фоне()(
    ПОКА ИСТИНА (
        НАПЕЧАТАТЬ "Я бесконечный цикл в таске, которую не ждут";
        !спать(0.1);
        !1/0;
    )
)


ОПРЕДЕЛИТЬ ПРОЦЕДУРУ пустая_таска()(
    ЦИКЛ ОТ 1 ДО 6 (
        ЕСЛИ ЛОЖЬ ТО (
            НАПЕЧАТАТЬ "Я ТАСКА";
        )
        ИНАЧЕ (
            2 + 2 * 2;
        )
    )

    !НАПЕЧАТАТЬ "пустая_таска ВЫПОЛНЕНА";
)

ОПРЕДЕЛИТЬ ПРОЦЕДУРУ вход_в_программу()(
    ЦИКЛ ОТ 1 ДО 760 (
        В ФОНЕ пустая_таска();
    )

   ! В ФОНЕ спам_в_фоне();
    Список();
    ЗАДАТЬ р = ГенераторСлучайныхЧисел();
    ЗАДАТЬ фон = массив(В ФОНЕ тест(р));

    ЗАДАТЬ синхронизатор = СобытиеСинхронизатор();
    ЗАДАТЬ фон2 = В ФОНЕ тест2(синхронизатор);

    !ПОКА ИСТИНА (
      !  НАПЕЧАТАТЬ "Основной цикл событий!\n\n";
    !)

    ЦИКЛ ОТ 1 ДО ЖДАТЬ В ФОНЕ дать_число() (
        добавить_в_массив(фон, В ФОНЕ тест(р));
    )

    НАПЕЧАТАТЬ ждать_всех(фон);

    !В ФОНЕ массив();
    синхронизатор:иницировать_событие();
    НАПЕЧАТАТЬ ЖДАТЬ фон2;

    !спать(2);
)


ВЫПОЛНИТЬ (
   !ЖДАТЬ В ФОНЕ вход_в_программу();
   вход_в_программу();
)
