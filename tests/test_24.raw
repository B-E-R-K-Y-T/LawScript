ВКЛЮЧИТЬ стандартная_библиотека.*


ОПРЕДЕЛИТЬ КЛАСС ФоновыйЧел (
    ОПРЕДЕЛИТЬ КОНСТРУКТОР (ссылка)() (
    )

    ОПРЕДЕЛИТЬ МЕТОД (ссылка) фонис(СИНХРАНИЗАТОР) (
        ЗАДАТЬ счет = 0;
        ПОКА ИСТИНА (

        ЕСЛИ СИНХРАНИЗАТОР:выполнено() ТО (
            ВЕРНУТЬ;
        )

            НАПЕЧАТАТЬ "Прив! ИЗ ФОНОВЫЙ ЧЕЛ НОМЕР = " + в_строку(счет);
            счет = счет + 1;
        )
    )
)

ОПРЕДЕЛИТЬ ПРОЦЕДУРУ рабочая_задача(ид, группировщик, ранд) (
    НАПЕЧАТАТЬ "Задача " + в_строку(ид) + " начала работу";

    !спать(ранд:получить_целое_в_диапазоне(1, 3));

    ЖДАТЬ В ФОНЕ спать_в_фоне(2);
    группировщик:готов();
    НАПЕЧАТАТЬ "Задача " + в_строку(ид) + " завершилась";
)

ОПРЕДЕЛИТЬ ПРОЦЕДУРУ фоновая_задача(СИНХРАНИЗАТОР) (
    ЗАДАТЬ счет = 0;
    ПОКА ИСТИНА (

        ЕСЛИ СИНХРАНИЗАТОР:выполнено() ТО (
            ВЕРНУТЬ;
        )

        НАПЕЧАТАТЬ "Прив! НОМЕР = " + в_строку(счет);
        счет = счет + 1;
    )
)


ОПРЕДЕЛИТЬ ПРОЦЕДУРУ перекладчик(оч, СИНХРАНИЗАТОР) (

    ЗАДАТЬ элемент = ПУСТОТА;

    ПОКА ИСТИНА (
        ЕСЛИ СИНХРАНИЗАТОР:выполнено() ТО (
            ВЕРНУТЬ;
        )

        КОНТЕКСТ (
        элемент = оч:взять() ;
            ЕСЛИ элемент ТО (
                НАПЕЧАТАТЬ "Всё ок, взял " + в_строку(элемент);
                ПРОПУСТИТЬ;
            )
            ЖДАТЬ В ФОНЕ спать_в_фоне(1);
        )
        ОБРАБОТЧИК ОчередьПолна КАК о (
            НАПЕЧАТАТЬ "ОЧЕРЕДБ ПЕРЕПОЛНЕНА2";
        )
   )
)

ОПРЕДЕЛИТЬ ПРОЦЕДУРУ вход() (
   ЗАДАТЬ оч = Очередь(1);
   ЗАДАТЬ СИНХРАНИЗАТОР = СобытиеСинхронизатор();
    ЗАДАТЬ перед = В ФОНЕ перекладчик(оч, СИНХРАНИЗАТОР);
    ЗАДАТЬ элемент = ПУСТОТА;

    ЗАДАТЬ ранд2 = ГенераторСлучайныхЧисел();

    ЦИКЛ ОТ 1 ДО 3 (
        ПОКА ИСТИНА (
            КОНТЕКСТ (
                элемент = ранд2:получить_число();
                оч:положить(элемент);
                НАПЕЧАТАТЬ "Положил: " + в_строку(элемент);
                ПРЕРВАТЬ;
            )
            ОБРАБОТЧИК ОчередьПолна КАК о (
                НАПЕЧАТАТЬ "ОЧЕРЕДБ ПЕРЕПОЛНЕНА";
                !спать(0.1);
            )
        )
    )
    !1 / 0;
    ЗАДАТЬ кол_во_задач = 10;

    ЗАДАТЬ группировщик = ГруппировщикЗадач();
    группировщик:добавить(кол_во_задач);
    ЗАДАТЬ ранд = ГенераторСлучайныхЧисел();
    ЗАДАТЬ фоновая = В ФОНЕ фоновая_задача(СИНХРАНИЗАТОР);
    ЗАДАТЬ фоновый_челикс = ФоновыйЧел();

    В ФОНЕ фоновый_челикс:фонис(СИНХРАНИЗАТОР);

    ЦИКЛ i ОТ 1 ДО кол_во_задач (
        В ФОНЕ рабочая_задача(i, группировщик, ранд);
    )

!    спать(3);
    НАПЕЧАТАТЬ "Ждем завершения всех задач...";

    КОНТЕКСТ (
        группировщик:ждать(0);
        СИНХРАНИЗАТОР:иницировать_событие();
        НАПЕЧАТАТЬ "Все задачи завершены!";
    )
    ОБРАБОТЧИК ОшибкаЗадачи КАК о (
        НАПЕЧАТАТЬ "блин, таймаут случился!!!";
    )

        СИНХРАНИЗАТОР:иницировать_событие();
    спать(1);
)

ВЫПОЛНИТЬ (
	вход();
)



